# Summary: Task 2.3.2 End Position Estimation

## Overview

Extended the `Location` module with end position estimation for AST nodes that lack explicit end metadata. This completes Section 2.3 Source Location Tracking.

## Problem Solved

Some AST constructs don't have explicit end position in metadata:
- Single-line definitions (`def foo, do: :ok`)
- Pipe expressions (`x |> foo() |> bar()`)
- Binary operations (`a + b`)

Previously, `extract_range/1` returned `end_line: nil, end_column: nil` for these constructs.

## Changes Made

### Extended: `lib/elixir_ontologies/analyzer/location.ex`

Added ~150 lines with 3 new public functions:

| Function | Description |
|----------|-------------|
| `estimate_end/1` | Walk AST to find last position |
| `extract_range_with_estimate/1` | extract_range with fallback estimation |
| `extract_range_with_estimate!/1` | Bang variant of above |

**Implementation approach:**
- Recursively traverse all AST children (3-tuples, 2-tuples, lists)
- Track the "latest" position (highest line, then column)
- Include positions from `:end`, `:closing`, `:end_of_expression` metadata
- Fall back to start position if no children have positions

**Documentation added:**
- New "End Position Estimation" section in moduledoc
- "Estimation Limitations" subsection documenting:
  - Column estimation may be inaccurate
  - Finds start of last token, not its end
  - Multi-line strings may not be accurately bounded
  - Comments not tracked (not in AST)

### Extended: `test/elixir_ontologies/analyzer/location_test.exs`

Added ~210 lines with 30 new tests:

| Category | Tests |
|----------|-------|
| estimate_end/1 | 8 tests |
| extract_range_with_estimate/1 | 11 tests |
| extract_range_with_estimate!/1 | 3 tests |
| Estimation edge cases | 5 tests |
| New doctests | 6 tests |
| **Total new** | **30 tests** |

## Key Implementation Details

```elixir
# Walk AST to find last position
defp find_last_position({_form, meta, args}, current_best) when is_list(meta) do
  node_pos = extract_position_from_meta(meta)
  current_best = compare_positions(current_best, node_pos)

  end_pos = extract_end_from_meta(meta)
  current_best = compare_positions(current_best, end_pos)

  find_last_position(args, current_best)
end

# Position comparison: higher line wins, then higher column
defp compare_positions({cur_line, cur_col}, {new_line, new_col}) do
  cond do
    new_line > cur_line -> {new_line, new_col}
    new_line == cur_line and new_col > cur_col -> {new_line, new_col}
    true -> {cur_line, cur_col}
  end
end
```

## Files Changed

| File | Change |
|------|--------|
| `lib/elixir_ontologies/analyzer/location.ex` | Extended - added ~150 lines |
| `test/elixir_ontologies/analyzer/location_test.exs` | Extended - added ~210 lines |
| `notes/features/2.3.2-end-position-estimation.md` | Updated to complete |
| `notes/planning/phase-02.md` | Marked task 2.3.2 and Section 2.3 complete |

## Metrics

| Metric | Value |
|--------|-------|
| New Tests | 30 (6 doctests + 24 unit) |
| Total Location Tests | 94 (23 doctests + 71 unit) |
| Total Project Tests | 650 (134 doctests + 516 unit) |
| New Public Functions | 3 |
| Lines Added | ~360 |

## How to Test

```bash
# Run Location tests
mix test test/elixir_ontologies/analyzer/location_test.exs

# Run all tests
mix test
```

## Usage Examples

```elixir
alias ElixirOntologies.Analyzer.Location

# Without estimation - returns nil end for some constructs
{:ok, ast} = Code.string_to_quoted("def foo, do: :ok", columns: true)
{:ok, loc1} = Location.extract_range(ast)
loc1.end_line  # => nil

# With estimation - always returns end position
{:ok, loc2} = Location.extract_range_with_estimate(ast)
loc2.end_line  # => 1

# Explicit estimation
{:ok, {line, col}} = Location.estimate_end(ast)
# => {:ok, {1, 14}}  (position of :ok)
```

## Section 2.3 Complete

With tasks 2.3.1 and 2.3.2 complete, Section 2.3 Source Location Tracking is finished:
- SourceLocation struct for representing ranges
- Extraction from AST metadata
- End position estimation when metadata unavailable
- 94 tests covering all functionality

## Next Task

The next items in the plan are the **Phase 2 Integration Tests**:
- Test full file parsing pipeline: read → parse → walk → extract locations
- Test walker finds all modules in multi-module file
- Test walker finds all functions in complex module
- Test location tracking through nested structures
- Test error handling for malformed files
