# Feature 2.1.2: AST Parser Module

## Problem Statement

The analyzer needs to parse Elixir source code into AST with enhanced source location tracking. Elixir's `Code.string_to_quoted/2` provides the foundation, but we need a wrapper that:
1. Enables source location tracking (line, column, token metadata)
2. Provides consistent, structured error messages
3. Integrates with the FileReader module for file-based parsing

## Solution Overview

Create a `Parser` module that wraps `Code.string_to_quoted/2` with:
1. Pre-configured options for maximum source location information
2. Structured error results with line/column information
3. Integration with FileReader for file-based parsing
4. Both ok/error and bang variants

## Technical Details

### File Location
`lib/elixir_ontologies/analyzer/parser.ex`

### Dependencies
- `ElixirOntologies.Analyzer.FileReader` - for reading files before parsing
- Elixir's `Code` module - for AST parsing

### API Design

| Function | Description |
|----------|-------------|
| `parse/1` | Parse source string with default options, return `{:ok, ast}` or `{:error, error}` |
| `parse/2` | Parse source string with custom options |
| `parse!/1` | Parse source string, raise on error |
| `parse!/2` | Parse source string with custom options, raise on error |
| `parse_file/1` | Read and parse file, return `{:ok, result}` or `{:error, error}` |
| `parse_file!/1` | Read and parse file, raise on error |
| `default_options/0` | Return default parser options |

### Result Structs

```elixir
# Successful parse result for files
%Parser.Result{
  path: String.t(),           # Absolute path to file
  source: String.t(),         # Original source code
  ast: Macro.t(),             # Parsed AST
  file_metadata: %{           # From FileReader
    size: non_neg_integer(),
    mtime: NaiveDateTime.t()
  }
}

# Parse error
%Parser.Error{
  message: String.t(),        # Error description
  line: pos_integer() | nil,  # Line number where error occurred
  column: pos_integer() | nil,# Column number where error occurred
  snippet: String.t() | nil   # Source snippet around error
}
```

### Parser Options

Default options for maximum location information:
```elixir
[
  columns: true,           # Include column information
  token_metadata: true,    # Include token metadata
  emit_warnings: false     # Suppress compiler warnings
]
```

### Error Handling

| Error | Return Value |
|-------|--------------|
| Syntax error | `{:error, %Parser.Error{message: ..., line: ..., column: ...}}` |
| File read error | `{:error, {:file_error, reason}}` |
| Encoding error | `{:error, {:file_error, {:encoding_error, details}}}` |

## Implementation Plan

- [x] 2.1.2.1 Create `lib/elixir_ontologies/analyzer/parser.ex`
- [x] 2.1.2.2 Implement `Parser.parse/1` accepting source string
- [x] 2.1.2.3 Configure parser options: `columns: true`, `token_metadata: true`
- [x] 2.1.2.4 Implement `Parser.parse/2` with custom options
- [x] 2.1.2.5 Return structured error on parse failure with line/column
- [x] 2.1.2.6 Implement `Parser.parse_file/1` combining read + parse
- [x] 2.1.2.7 Write parser tests including error cases

## Success Criteria

- [x] All functions implemented with proper typespecs
- [x] Comprehensive documentation with examples
- [x] Tests covering:
  - Parsing valid source code
  - Parsing invalid source code (syntax errors)
  - Line/column extraction from errors
  - parse/2 with custom options
  - parse_file/1 integration with FileReader
  - Bang variants
- [x] Error handling returns clear, actionable messages
- [x] Source locations available in parsed AST

## Current Status

**Status**: Complete

### What Works
- Feature branch created: `feature/2.1.2-ast-parser`
- Planning document created
- Parser module implemented with full API
- 41 tests passing (34 unit + 7 doctests)

### Functions Implemented
- `parse/1` - Parse source string with default options
- `parse/2` - Parse source string with custom options
- `parse!/1` - Parse with exception on error
- `parse!/2` - Parse with options and exception on error
- `parse_file/1` - Read and parse file
- `parse_file!/1` - Read and parse file with exception on error
- `default_options/0` - Return default parser options

### How to Run
```bash
mix test test/elixir_ontologies/analyzer/parser_test.exs
```
