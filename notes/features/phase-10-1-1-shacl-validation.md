# Phase 10.1.1 - SHACL Validation Module - Implementation Plan

## Problem Statement

Implement SHACL validation for RDF knowledge graphs generated by the Elixir code analyzer. The validator must:

1. Load SHACL shapes from `priv/ontologies/elixir-shapes.ttl` (19KB, 598 lines)
2. Validate RDF graphs against these shapes
3. Return structured validation reports with clear error messages
4. Integrate with existing Mix task (`--validate` flag)
5. Provide comprehensive test coverage (12+ tests)

**Key Challenge:** The Elixir RDF ecosystem lacks native SHACL validation support. We must integrate with external SHACL validators while providing a clean Elixir API.

## Solution Overview

**Recommended Approach: pySHACL Integration**

Use pySHACL as the validation engine, wrapped in a clean Elixir API:

1. **Validator Module** (`lib/elixir_ontologies/validator.ex`)
   - Detects if pySHACL is installed
   - Serializes graphs to temporary files
   - Executes pySHACL via System.cmd/3
   - Parses validation reports (Turtle format)
   - Returns structured Elixir data structures

2. **Validation Report Parsing**
   - Parse SHACL validation report RDF
   - Extract violations with focus nodes, paths, messages
   - Convert to user-friendly Elixir structs

3. **Mix Task Integration**
   - Add `--validate` flag to `mix elixir_ontologies.analyze`
   - Automatically validate after analysis
   - Display validation results to user

4. **Graceful Degradation**
   - Check for pySHACL availability at runtime
   - Return helpful error if not installed
   - Document installation requirements

**Why pySHACL:**
- Simple installation (`pip install pyshacl`)
- Clean command-line interface
- Well-documented exit codes and output formats
- Active maintenance (0.30.1 released 2025)
- Supports all SHACL features we need

## Implementation Progress

### ✅ Phase 1: Core Validator Module
**Status**: PENDING

- [ ] Create `lib/elixir_ontologies/validator/report.ex`
- [ ] Create `lib/elixir_ontologies/validator/shacl_engine.ex`
- [ ] Create `lib/elixir_ontologies/validator/report_parser.ex`
- [ ] Create `lib/elixir_ontologies/validator.ex`

### ⏳ Phase 2: Mix Task Integration
**Status**: PENDING

- [ ] Update `lib/mix/tasks/elixir_ontologies.analyze.ex`

### ⏳ Phase 3: Testing
**Status**: PENDING

- [ ] Create `test/elixir_ontologies/validator_test.exs` (12 tests)
- [ ] Create `test/elixir_ontologies/validator/report_parser_test.exs`
- [ ] Update `test/mix/tasks/elixir_ontologies.analyze_test.exs`

### ⏳ Phase 4: Documentation
**Status**: PENDING

- [ ] Add comprehensive module documentation
- [ ] Create validation usage guide

## Success Criteria

### Functional Requirements
- [ ] Validator.validate/2 successfully validates graphs
- [ ] Returns structured Report with violations
- [ ] Detects pySHACL availability
- [ ] Provides clear installation instructions
- [ ] --validate flag works in Mix task
- [ ] Handles missing validator gracefully

### Quality Requirements
- [ ] 12+ comprehensive tests passing
- [ ] All public functions documented
- [ ] Error messages clear and actionable
- [ ] Temporary files cleaned up properly
- [ ] No external dependencies in mix.exs

### Performance Requirements
- [ ] Validation completes in <5 seconds for typical graphs
- [ ] No memory leaks from temporary files
- [ ] Graceful handling of large graphs

## Current Status

**Overall Progress**: 0% (Planning Complete)

### What Works
- SHACL shapes file exists (`priv/ontologies/elixir-shapes.ttl`)
- Graph generation works (Phases 1-9)
- Mix tasks infrastructure exists

### What's Next
- Implement Report data structures
- Implement pySHACL wrapper
- Implement report parser
- Implement main Validator module

### How to Test (Once Implemented)
```bash
# Install pySHACL
pip install pyshacl

# Validate during analysis
mix elixir_ontologies.analyze --validate

# Programmatic usage
iex -S mix
{:ok, graph} = ElixirOntologies.analyze_project(".")
{:ok, report} = ElixirOntologies.Validator.validate(graph)
```

## Technical Details

### Module Structure
```
lib/elixir_ontologies/
  validator.ex              # Main validation module
  validator/
    report.ex              # Validation report data structures
    shacl_engine.ex        # pySHACL wrapper
    report_parser.ex       # Parse validation reports
```

### API Design
```elixir
# Main validation function
@spec validate(Graph.t(), keyword()) :: {:ok, Report.t()} | {:error, term()}
def validate(graph, opts \\ [])

# Check if validator available
@spec available?() :: boolean()
def available?()

# Get installation instructions
@spec installation_instructions() :: String.t()
def installation_instructions()
```

### pySHACL Integration
```bash
# Command structure
pyshacl -s shapes.ttl -df turtle -f turtle data.ttl

# Exit codes
0 = conformant
1 = non-conformant
2 = error
```

## Dependencies

**No new Mix dependencies required:**
- Uses existing `rdf` library for Turtle parsing
- pySHACL is runtime-detected external tool
- All functionality gracefully degrades if unavailable

**System Requirements:**
- Python 3.9+ (for pySHACL)
- pip or conda (for installation)
