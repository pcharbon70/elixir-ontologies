# Feature 2.3.1: Location Extractor

## Problem Statement

After parsing Elixir source code into AST, we need to extract source location information from AST node metadata. This enables:
- Tracking where each code element appears in source files
- Supporting `hasSourceLocation` RDF property
- Enabling IDE-like navigation features
- Providing precise error/analysis reporting

Elixir's AST stores location in node metadata (second element of 3-tuple). With `columns: true` and `token_metadata: true` parser options, metadata includes:
- `line` - Start line number
- `column` - Start column number
- `end` - `[line: n, column: m]` for block end positions
- `do` - `[line: n, column: m]` for do keyword position
- `closing` - `[line: n, column: m]` for closing delimiter position

## Solution Overview

Create a `Location` module that:
1. Extracts location from AST node metadata
2. Provides a `SourceLocation` struct with start/end positions
3. Handles nodes without metadata gracefully
4. Estimates end positions when not available

## Technical Details

### File Location
`lib/elixir_ontologies/analyzer/location.ex`

### Dependencies
- None (pure pattern matching on AST metadata)

### Metadata Structure

From AST examination, metadata can contain:
```elixir
# defmodule with block
[
  end_of_expression: [newlines: 1, line: 9, column: 4],
  do: [line: 1, column: 19],
  end: [line: 9, column: 1],
  line: 1,
  column: 1
]

# def with block
[
  end_of_expression: [newlines: 2, line: 6, column: 6],
  do: [line: 4, column: 19],
  end: [line: 6, column: 3],
  line: 4,
  column: 3
]

# Function call with closing paren
[closing: [line: 4, column: 17], line: 4, column: 7]
```

### API Design

| Function | Description |
|----------|-------------|
| `extract/1` | Get start line/column from node |
| `extract_range/1` | Get start and end positions |
| `span/2` | Calculate span from start to end node |

### SourceLocation Struct

```elixir
defstruct [
  :start_line,
  :start_column,
  :end_line,
  :end_column
]
```

## Implementation Plan

- [x] 2.3.1.1 Create `lib/elixir_ontologies/analyzer/location.ex`
- [x] 2.3.1.2 Implement `Location.extract/1` getting line/column from AST node
- [x] 2.3.1.3 Implement `Location.extract_range/1` getting start and end positions
- [x] 2.3.1.4 Handle nodes without location metadata (return nil gracefully)
- [x] 2.3.1.5 Implement `Location.span/2` calculating extent from start/end nodes
- [x] 2.3.1.6 Create `%SourceLocation{}` struct with start_line, end_line, start_column, end_column
- [x] 2.3.1.7 Write location extraction tests

## Success Criteria

- [x] All functions implemented with proper typespecs
- [x] Comprehensive documentation with examples
- [x] Tests covering:
  - Extraction from nodes with full metadata
  - Extraction from nodes with partial metadata
  - Graceful handling of missing metadata
  - Span calculation between nodes
- [x] Handles all Elixir AST node types gracefully

## Current Status

**Status**: Complete

### What Works
- Feature branch created: `feature/2.3.1-location-extractor`
- Planning document created
- Location module implemented with 8 public functions
- SourceLocation struct with start/end line/column fields
- 64 tests passing (17 doctests + 47 unit tests)

### Functions Implemented
- `extract/1`, `extract!/1` - Get start line/column from node
- `extract_range/1`, `extract_range!/1` - Get full SourceLocation with end positions
- `span/2`, `span!/2` - Calculate span between two nodes
- `has_location?/1` - Check if node has location metadata
- `line/1`, `column/1` - Convenience functions for single values

### How to Run
```bash
mix test test/elixir_ontologies/analyzer/location_test.exs
```
