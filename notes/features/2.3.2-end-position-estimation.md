# Feature 2.3.2: End Position Estimation

## Problem Statement

Some AST constructs don't have explicit end position metadata:
- Single-line definitions (`def foo, do: :ok`)
- Pipe expressions (`x |> foo() |> bar()`)
- Binary operations (`a + b`)
- Attribute values (`@attr value`)

When `extract_range/1` returns `end_line: nil, end_column: nil`, we need heuristics to estimate the end position.

## Solution Overview

Add estimation functions to the Location module that:
1. Walk the AST to find the deepest/last child node
2. Use that child's position as the end position estimate
3. Handle single-line constructs (end = start line)
4. Document limitations of estimation

## Technical Details

### File Location
Extend `lib/elixir_ontologies/analyzer/location.ex`

### Dependencies
- `ElixirOntologies.Analyzer.ASTWalker` (for traversing to find last child)

### Cases Identified

| Construct | Has End Metadata? | Estimation Strategy |
|-----------|-------------------|---------------------|
| `defmodule ... end` | Yes (`:end` key) | N/A - use metadata |
| `def ... end` | Yes (`:end` key) | N/A - use metadata |
| `def foo, do: expr` | No | Find last child position |
| `fn x -> x end` | Yes (`:closing` key) | N/A - use metadata |
| `hello()` | Yes (`:closing` key) | N/A - use metadata |
| `x |> foo()` | No | Find rightmost operand position |
| `a + b` | No | Find rightmost operand position |
| `@attr value` | No | Find value position |

### API Design

| Function | Description |
|----------|-------------|
| `estimate_end/1` | Estimate end position by walking AST |
| `extract_range_with_estimate/1` | Like extract_range but with fallback estimation |

## Implementation Plan

- [x] 2.3.2.1 Implement end line estimation from last child node
- [x] 2.3.2.2 Implement end line estimation from `end` keyword for blocks (already done)
- [x] 2.3.2.3 Handle single-line constructs (end_line = start_line)
- [x] 2.3.2.4 Document estimation limitations
- [x] 2.3.2.5 Write estimation tests with various constructs

## Success Criteria

- [x] `estimate_end/1` returns position for nodes without explicit end
- [x] `extract_range_with_estimate/1` never returns nil end positions
- [x] Single-line constructs handled correctly
- [x] Limitations documented in moduledoc
- [x] Tests cover all identified cases

## Current Status

**Status**: Complete

### What Works
- Feature branch created: `feature/2.3.2-end-position-estimation`
- Planning document created
- `estimate_end/1` implemented - walks AST to find last position
- `extract_range_with_estimate/1` implemented - falls back to estimation
- `extract_range_with_estimate!/1` implemented - bang variant
- Estimation limitations documented in moduledoc
- 30 new tests added (6 doctests + 24 unit tests)

### Functions Implemented
- `estimate_end/1` - Recursively finds last position in AST
- `extract_range_with_estimate/1` - extract_range with fallback estimation
- `extract_range_with_estimate!/1` - Bang variant

### How to Run
```bash
mix test test/elixir_ontologies/analyzer/location_test.exs
```
